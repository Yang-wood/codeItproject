<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/layout/basic :: setContent(~{this::contentWrapper})}">
	<th:block th:fragment="contentWrapper">
		<div th:replace="~{/book/subheader :: withSubHeader(~{this::myActualPageContent})}">
			<th:block th:fragment="myActualPageContent">
				<script th:src="@{/js/starrr.js}"></script>
				<link th:href="@{/css/starrr.css}" rel="stylesheet">
				
				<div class="container py-4">
				    <div class="container">
	                	<div style="height: 100px;"></div>
				        <hr>
				        <div id="bookListContainer">
				        	<div th:if="${#lists.isEmpty(rentList)}" class="text-center text-muted mt-5">
			                	<p>ëŒ€ì—¬ì¤‘ì¸ ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
			            	</div>
				            <div th:each="book : ${rentList}" class="book-item d-flex align-items-start">
				                <img th:src="${book.coverImage}" alt="í‘œì§€" class="book-cover">
				                <div class="book-info">
				                    <div class="book-title" th:text="${book.title}">ë„ì„œ ì œëª©</div>
				                    <div class="text-muted mb-1">
				                        ì €ì : <span th:text="${book.author}">ì €ì</span> |
				                        ì¶œíŒì‚¬ : <span th:text="${book.publisher}">ì¶œíŒì‚¬</span>
				                    </div>
				                    <div class="book-description" th:text="${book.description}">
				                        ë„ì„œ ì„¤ëª…
				                    </div>
				                   	<div style="height: 10px;">
				                   	</div>
				                    <div class="star-rating text-warning">
									  <!-- ê½‰ ì°¬ ë³„ -->
									  <i class="fa fa-star"
									     th:each="i : ${book.avgRating >= 1 ? #numbers.sequence(1, T(java.lang.Math).floor(book.avgRating)) : {}}"></i>
									  <!-- ë°˜ ë³„ -->
									  <i class="fa fa-star-half-o"
									     th:if="${(book.avgRating % 1) >= 0.25 and (book.avgRating % 1) < 0.75}"></i>
									  <!-- 0.75 ì´ìƒì´ë©´ ë°˜ ë³„ ëŒ€ì‹  ê½‰ ì°¬ ë³„ í•˜ë‚˜ ì¶”ê°€ -->
									  <i class="fa fa-star"
									     th:if="${(book.avgRating % 1) >= 0.75}"></i>
									  <!-- ë¹ˆ ë³„ ê³„ì‚° -->
									  <i class="fa fa-star-o"
									     th:each="i : ${#numbers.sequence(1, 5 - T(java.lang.Math).floor(book.avgRating) - ((book.avgRating % 1 >= 0.75) ? 1 : (book.avgRating % 1 >= 0.25 ? 1 : 0)))}"></i>
									  <small class="text-muted" th:text="'(' + ${book.avgRating} + ')'"></small>
									</div>
				                </div>
				                <div class="book-buttons">
				                	<button th:if="${book.wishedByCurrentUser}" 
				                    		th:data-book-id="${book.bookId}"
				                    		class="btn btn-primary wishBtn">â™¥</button>
				                    <button th:if="${!book.wishedByCurrentUser}" 
				                    		th:data-book-id="${book.bookId}"
				                    		class="btn btn-outline-primary wishBtn">â™¡</button>
				                    
				                    <a th:if="${book.rentedByCurrentUser}"
				                       th:href="@{/book/epubRead(bookId=${book.bookId})}" class="btn btn-primary read-button">ì—´ëŒí•˜ê¸°</a>
				                    <button th:if="${!book.rentedByCurrentUser}" 
				                    		th:data-book-id="${book.bookId}"
				                    		class="btn btn-success rentBtn">ëŒ€ì—¬í•˜ê¸°</button>
				                    		
				                    <button th:if="${book.reviewByCurrentUser}"
				                    		th:data-book-id="${book.bookId}" 
				                    		th:data-rent-id="${book.rentId}" 
				                    		class="btn btn-success reviewListBtn"
				                    		data-toggle="modal" data-target="#reviewListModal">ë¦¬ë·°ë³´ê¸°</button>
				                    <button th:if="${!book.reviewByCurrentUser}"
				                    		th:data-book-id="${book.bookId}"
				        					th:data-rent-id="${book.rentId}" 
				                    		class="btn btn-outline-primary reviewRegBtn"
				                    		data-toggle="modal" data-target="#reviewWriteModal">ë¦¬ë·°ì“°ê¸°</button>
				                    		
				                    <div class="point-text">í•„ìš” í¬ì¸íŠ¸ : <span th:text="${book.rentPoint}">ìš”êµ¬ í¬ì¸íŠ¸</span></div>
				                </div>
				            </div>
				        </div>
				    </div>
					
				    <div class="mt-4 text-center" th:if="${page.totalPages > 1}">
				        <nav>
				            <ul class="pagination justify-content-center">
				                <li class="page-item" th:if="${!page.first}">
				                    <a class="page-link"
				                       th:href="@{/book/rentList(page=0, size=${page.size})}"
				                       tabindex="-1">&lt;&lt;</a>
				                </li>
				                <li class="page-item" th:if="${!page.first}">
				                    <a class="page-link"
				                       th:href="@{/book/rentList(page=${page.number - 1}, size=${page.size})}"
				                       tabindex="-1">&lt;</a>
				                </li>
				                <li th:each="i : ${#numbers.sequence(startPage, endPage)}"
				                    th:classappend="${i} == ${page.number} ? 'active'" class="page-item">
				                    <a class="page-link"
				                       th:href="@{/book/rentList(page=${i}, size=${page.size})}"
				                       th:text="${i + 1}">1</a>
				                </li>
				                <li class="page-item" th:if="${!page.last}">
				                    <a class="page-link"
				                       th:href="@{/book/rentList(page=${page.number + 1}, size=${page.size})}"
				                       tabindex="-1">&gt;</a>
				                </li>
				                <li class="page-item" th:if="${!page.last}">
				                    <a class="page-link"
				                       th:href="@{/book/rentList(page=${page.totalPages - 1}, size=${page.size})}"
				                       tabindex="-1">&gt;&gt;</a>
				                </li>
				            </ul>
				        </nav>
				    </div>
				    <div class="modal fade" id="reviewRegModal" tabindex="-1" aria-labelledby="reviewRegModalLabel"
				     	 aria-hidden="true" data-backdrop="static" data-keyboard="false">
					    <div class="modal-dialog">
					        <div class="modal-content">
					            <div class="modal-header">
					                <h5 class="modal-title" id="reviewRegModalLabel">ë¦¬ë·° ì‘ì„±</h5>
					                <button type="button" class="btn-close" data-dismiss="modal"></button>
					            </div>
					            <div class="modal-body">
					                <p>ì±… ì œëª©: <span id="regModalTitle"></span></p>
					                <div class="mb-3">
					                    <label for="reviewTitle" class="form-label">ì œëª© : </label>
					                    <input type="text" class="form-control" id="reviewTitle" required>
					                </div>
					                <div class="mb-3">
					                    <label for="reviewContent" class="form-label">ë‚´ìš© : </label>
					                    <textarea class="form-control" id="reviewContent" rows="3" required></textarea>
					                </div>
					                <div class="form-group mb-3">
										<label class="col-form-label">í‰ì  : <span class="rating"></span></label>
										<div class="starrr"></div>
									</div>
									<div>
						                <input type="hidden" id="regModalBookId">
						                <input type="hidden" id="regModalRentId">
						                <input type="hidden" id="regModalReviewId">
									</div>
					            </div>
					            <div class="modal-footer">
					                <button type="button" class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
					                <button type="button" class="btn btn-primary" id="regReviewBtn">ë“±ë¡</button>
					                <button type="button" class="btn btn-warning d-none" id="modifyReviewBtn">ìˆ˜ì •</button>
					                <button type="button" class="btn btn-danger d-none" id="removeReviewBtn">ì‚­ì œ</button>
					            </div>
					        </div>
					    </div>
					</div>
					<div class="modal fade" id="reviewListModal" tabindex="-1" aria-labelledby="reviewListModalLabel"
						 aria-hidden="true" data-backdrop="static" data-keyboard="false">
					    <div class="modal-dialog modal-lg">
					        <div class="modal-content">
					            <div class="modal-header">
					                <h5 class="modal-title" id="reviewListModalLabel">ë¦¬ë·° ëª©ë¡</h5>
					                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
					            </div>
					            <div class="modal-body">
					                <div id="reviewsContainer" class="list-group">
					                    <p class="text-muted">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
				                    </div>
					            </div>
					            <div class="modal-footer">
					                <button type="button" class="btn btn-secondary" data-dismiss="modal">ë‹«ê¸°</button>
					            </div>
					        </div>
					    </div>
					</div>
				</div>
				
				
				<script th:inline="javascript">
				$(document).ready(function() {
					
					// ë¦¬ë·° ê´€ë ¨ ë²„íŠ¼ ê¸°ëŠ¥
					let rating = 3;
					
					$(".starrr").starrr({
						rating : rating,
						change : function(e, value) {
							if(value) {
								console.log(value);
								rating = value;
								$(".rating").text(rating);
							}
						}
					});
					
					const reviewRegBtn = $(".reviewRegBtn");
					const reviewListBtn = $(".reviewListBtn");
					
					reviewRegBtn.on("click", function() {
						const bookId = $(this).data("book-id");
						const rentId = $(this).data("rent-id");
						const bookTitle = $(this).closest(".book-item").find(".book-title").text();
						
						$("#regModalBookId").val(bookId);
						$("#regModalRentId").val(rentId);
						$("#regModalTitle").text(bookTitle);
						
						rating = 3;  // ì´ˆê¸°í™”
						$(".starrr").starrr("setRating", rating);
						$(".rating").text(rating);
				
						$("#reviewTitle").val("");
						$("#reviewContent").val("");
				
						$("#reviewRegModal").modal("show");
						
						$("#regModalReviewId").val(""); 
					    $("#regReviewBtn").removeClass("d-none");
					    $("#modifyReviewBtn").addClass("d-none");
					    $("#removeReviewBtn").addClass("d-none");
					});
					
					$("#regReviewBtn").on("click", function() {
						const reviewData = {
							bookId: $("#regModalBookId").val(),
						    rentId: $("#regModalRentId").val(),
						    title: $("#reviewTitle").val(),
						    content: $("#reviewContent").val(),
						    rating: rating	
						};
						
						if(!reviewData.title || !reviewData.content || !reviewData.rating) {
						    alert("ì œëª©ê³¼ ë‚´ìš©, ë³„ì ì„ ì…ë ¥í•˜ì„¸ìš”.");
						    return;
						}
						
						$.ajax({
						    url: "/api/book/regReview",
						    method: "post",
						    contentType: "application/json",
						    data: JSON.stringify(reviewData),
						    success: function(response) {
						    	if (response.message) {
						            alert(response.message);
						        } else {
						            alert("ë¦¬ë·°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
						        }
						    	$("#reviewRegModal").modal('hide');
						    	location.reload();
						    },
						    error: function(xhr, status, error) {
						        console.error("ì—ëŸ¬ ë°œìƒ:", xhr.status, xhr.responseText);
						        alert("ë¦¬ë·° ë“±ë¡ ì¤‘ ì—ëŸ¬ ë°œìƒ");
						    }
						 });
					});
					
					function loadReviewList(bookId) {
					    $("#reviewsContainer").html('<p class="text-muted">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>');
					    
					    $.ajax({
					        url: `/api/book/myReviewList/${bookId}`,
					        method: "GET",
					        success: function (reviews) {
					            if (reviews.length === 0) {
					                $("#reviewsContainer").html('<p class="text-muted">ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
					                return;
					            }
					            
					            function escapeHtml(str) {
					                return str.replace(/[&<>"']/g, function(match) {
					                    return ({
					                        '&': '&amp;',
					                        '<': '&lt;',
					                        '>': '&gt;',
					                        '"': '&quot;',
					                        "'": '&#39;'
					                    })[match];
					                });
					            }
				
					            let html = '';
					            reviews.forEach(review => {
					                html += `
					                  <div class="list-group-item review-item" 
					                       data-review-id="${review.reviewId}" 
					                       data-book-id="${review.bookId}"
					                       data-rent-id="${review.rentId}"
					                       data-title="${review.title}"
					                       data-content="${review.content}"
					                       data-rating="${review.rating}">
					                    <h5 class="mb-1 text-primary">ğŸ“š ${escapeHtml(review.title)}</h5>
					                    <p class="mb-1">${escapeHtml(review.content)}</p>
					                    <small>
					                      <span>â­ ${review.rating}ì </span> |
					                      <span>${new Date(review.regdate).toLocaleDateString()}</span>
					                    </small>
					                  </div>
					                `;
					            });
				
					            $("#reviewsContainer").html(html);
					        },
					        error: function () {
					            $("#reviewsContainer").html('<p class="text-danger">ë¦¬ë·° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>');
					        }
					    });
					}
					reviewListBtn.on("click", function() {
						const bookId = $(this).data("book-id");
					    const bookTitle = $(this).closest(".book-item").find(".book-title").text();
					    $("#reviewListModal").modal("show");
					    $("#listModalBookTitle").text(bookTitle);
					    loadReviewList(bookId);
					    
					})
					
					$("#reviewsContainer").on("click", ".review-item", function() {
					    const reviewId = $(this).data("review-id");
					    const bookId = $(this).data("book-id");
					    const rentId = $(this).data("rent-id");
					    const title = $(this).data("title");
				    const content = $(this).data("content");
				    const rating = $(this).data("rating");
				    
				    $("#regModalReviewId").val(reviewId);
				    $("#regModalBookId").val(bookId);
				    $("#regModalRentId").val(rentId);
				    $("#reviewTitle").val(title);
				    $("#reviewContent").val(content);
				    $(".starrr").starrr("setRating", rating); 
				    $(".rating").text(rating);
				    
				    $("#regModalTitle").text(title); 
				    
				    $("#regReviewBtn").addClass("d-none");
				    $("#modifyReviewBtn").removeClass("d-none").text("ìˆ˜ì •");
				    $("#removeReviewBtn").removeClass("d-none").text("ì‚­ì œ");
				    
				    $("#reviewListModal").modal("hide");
				    $("#reviewRegModal").modal("show");
				});
				
				$("#modifyReviewBtn").on("click", function() {
				    const reviewId = $("#regModalReviewId").val();
				    const bookId = $("#regModalBookId").val();
				    const rentId = $("#regModalRentId").val();
				    const title = $("#reviewTitle").val();
				    const content = $("#reviewContent").val();
				    const ratingValue = rating;
				    
				    console.log({ bookId, rentId, title, content, ratingValue });
				    
				    $.ajax({
				        url: `/api/book/modifyReview/${reviewId}`, // ìˆ˜ì • API ì—”ë“œí¬ì¸íŠ¸
				        method: "PUT",
				        contentType: "application/json",
				        data: JSON.stringify({bookId, rentId, title, content, rating}),
				        success: function() {
				            alert("ë¦¬ë·°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
				            $("#reviewRegModal").modal("hide");
				            $("#reviewListModal").modal("show");
				            // ë¦¬ë·° ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ ë˜ëŠ” ìˆ˜ì •ëœ ë¦¬ë·° ë¶€ë¶„ë§Œ ê°±ì‹ 
				            loadReviewList(bookId);
				        },
				        error: function() {
				            alert("ë¦¬ë·° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
				        }
				    });
				});
				
				$("#removeReviewBtn").on("click", function() {
					
					if(!confirm("ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
						return;
					}
					
				    const reviewId = $("#regModalReviewId").val();
				    $.ajax({
				        url: `/api/book/removeReview/${reviewId}`,
				        method: "DELETE",
				        success: function() {
				            alert("ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
				            $("#reviewRegModal").modal("hide");
				            location.reload();
				        },
				        error: function() {
				            alert("ë¦¬ë·° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
				        }
				    });
				});
				
			});
			</script>
			</th:block>
		</div>
	</th:block>
</th:block>



